package main

import (
	"os"

	"github.com/pulumi/pulumi-cloudflare/sdk/v5/go/cloudflare"
	"github.com/pulumi/pulumi-kubernetes/sdk/v4/go/kubernetes"
	"github.com/pulumi/pulumi/sdk/v3/go/pulumi"
)

// NewKubernetesProvider creates a Kubernetes provider from the kubeconfig file
// generated by the CLI at ../kubeconfig
func NewKubernetesProvider(ctx *pulumi.Context) (*kubernetes.Provider, error) {
	// Read kubeconfig from file
	kubeconfigPath := "../kubeconfig"
	kubeconfigContent, err := os.ReadFile(kubeconfigPath)
	if err != nil {
		return nil, err
	}

	// Create Kubernetes provider
	provider, err := kubernetes.NewProvider(ctx, "k8s", &kubernetes.ProviderArgs{
		Kubeconfig: pulumi.String(string(kubeconfigContent)),
	})
	if err != nil {
		return nil, err
	}

	return provider, nil
}

// NewCloudflareProvider creates a Cloudflare provider with explicit credentials
func NewCloudflareProvider(ctx *pulumi.Context, cfg *CloudflareConfig) (*cloudflare.Provider, error) {
	// Create Cloudflare provider with explicit API token
	provider, err := cloudflare.NewProvider(ctx, "cloudflare", &cloudflare.ProviderArgs{
		ApiToken: pulumi.String(cfg.APIToken),
	})
	if err != nil {
		return nil, err
	}

	return provider, nil
}

// Providers holds all infrastructure providers
type Providers struct {
	Kubernetes *kubernetes.Provider
	Cloudflare *cloudflare.Provider
}

// NewProviders creates all required infrastructure providers
func NewProviders(ctx *pulumi.Context, cfg *Config) (*Providers, error) {
	// Create Kubernetes provider from kubeconfig
	k8sProvider, err := NewKubernetesProvider(ctx)
	if err != nil {
		return nil, err
	}

	// Create Cloudflare provider
	cfProvider, err := NewCloudflareProvider(ctx, &cfg.Cloudflare)
	if err != nil {
		return nil, err
	}

	return &Providers{
		Kubernetes: k8sProvider,
		Cloudflare: cfProvider,
	}, nil
}
