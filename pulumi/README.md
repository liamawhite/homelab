# Homelab Pulumi Infrastructure

This directory contains the Pulumi Go infrastructure as code for deploying Kubernetes components to the homelab cluster.

## Components

### Kube-vip

Provides control plane high availability via a virtual IP (VIP) that fronts the Kubernetes API server.

**Features:**
- Control plane HA with automatic failover
- Leader election via Kubernetes leases
- ARP-based VIP advertisement
- **Does NOT manage Service LoadBalancers** (MetalLB handles that)

**Configuration:**
- VIP: Loaded from `../infra.yaml` (`cluster.vip`)
- Interface: Hardcoded to `eth0` (Raspberry Pi default)
- Version: Configured in `Pulumi.homelab.yaml` (`homelab:kubevip:version`)

## Prerequisites

1. **Bootstrapped cluster**: Run CLI commands first to bootstrap the cluster:
   ```bash
   # From root directory
   ./homelab bootstrap --node pi-0
   ./homelab k3s --node pi-0 --cluster-init
   ./homelab kubeconfig --node pi-0
   ```

2. **Kubeconfig**: Must exist at `../kubeconfig` (generated by CLI)

3. **Pulumi**: Install Pulumi CLI
   ```bash
   # macOS
   brew install pulumi/tap/pulumi

   # Linux
   curl -fsSL https://get.pulumi.com | sh
   ```

4. **Dependencies**: Install Go dependencies
   ```bash
   # From repository root
   go mod download
   ```

## Usage

### Initial Setup

1. **Configure Pulumi stack** (if not already done):
   ```bash
   cd pulumi
   pulumi stack init homelab
   ```

2. **Configure kube-vip settings** (optional):

   Edit `Pulumi.homelab.yaml` to override version:
   ```yaml
   config:
     homelab:kubevip:
       version: "v1.0.3"
   ```

   Or use CLI command:
   ```bash
   # Override kube-vip version (default: v1.0.3)
   pulumi config set --path 'homelab:kubevip.version' v1.0.3
   ```

### Deploy

```bash
cd pulumi
pulumi up
```

This will:
1. Load configuration from `../infra.yaml`
2. Create Kubernetes provider using `../kubeconfig`
3. Deploy kube-vip DaemonSet to control plane nodes
4. Export VIP and configuration as stack outputs

### Verify Deployment

```bash
# Check kube-vip pods are running
kubectl get pods -n kube-system -l app.kubernetes.io/name=kube-vip

# View logs
kubectl logs -n kube-system -l app.kubernetes.io/name=kube-vip

# Test VIP responds
ping 192.168.1.50

# Verify leader election
kubectl get leases -n kube-system | grep vip
```

### Update Kubeconfig to Use VIP

After kube-vip is deployed, update your kubeconfig to use the VIP:

```bash
# Backup current kubeconfig
cp kubeconfig kubeconfig.backup

# Update server URL to use VIP
# Change: server: https://192.168.1.51:6443
# To:     server: https://192.168.1.50:6443
sed -i '' 's|server: https://192.168.1.51:6443|server: https://192.168.1.50:6443|' ../kubeconfig

# Test API access via VIP
kubectl --kubeconfig=../kubeconfig get nodes
```

### Destroy

```bash
cd pulumi
pulumi destroy
```

## Architecture

### Component Structure

```
pulumi/
├── main.go                           # Entry point
├── config.go                         # Configuration loading
├── provider.go                       # Kubernetes provider
├── pkg/
│   └── kubevip/
│       ├── component.go              # ComponentResource
│       ├── rbac.go                   # RBAC resources
│       └── daemonset.go              # DaemonSet definition
├── Pulumi.yaml                       # Project metadata
├── Pulumi.homelab.yaml               # Stack configuration
└── README.md                         # This file
```

### Kube-vip Configuration

**Environment Variables** (set in DaemonSet):
- `vip_arp=true`: Use ARP for VIP advertisement
- `cp_enable=true`: Enable control plane mode
- `svc_enable=false`: **CRITICAL** - Disable service load balancing (MetalLB handles this)
- `vip_leaderelection=true`: Use Kubernetes leader election
- `address=192.168.1.50`: VIP address from infra.yaml

**Node Affinity**:
- Only runs on nodes with `node-role.kubernetes.io/control-plane=true`
- Tolerates control plane taints

**Resources** (Raspberry Pi optimized):
- Requests: 50m CPU, 64Mi memory
- Limits: 100m CPU, 128Mi memory

## Configuration Files

### `../infra.yaml`

Main configuration file (shared with CLI):
```yaml
cluster:
  vip: 192.168.1.50  # Control plane VIP
  sans:
    - 192.168.1.50
```

### `Pulumi.homelab.yaml`

Pulumi stack configuration (nested object structure):
```yaml
config:
  homelab:kubevip:
    version: "v1.0.3"
```

## Integration with CLI

The Pulumi infrastructure works alongside the CLI tool:

1. **CLI**: Bootstraps infrastructure (Raspberry Pi provisioning, K3s installation)
2. **Pulumi**: Deploys Kubernetes components (kube-vip, future: MetalLB, Istio, etc.)

**Workflow**:
```bash
# 1. Bootstrap infrastructure (CLI)
./homelab bootstrap --node pi-0
./homelab k3s --node pi-0 --cluster-init
./homelab kubeconfig --node pi-0
./homelab clustertoken --node pi-0  # Saves to ./cluster-token

# 2. Deploy Kubernetes components (Pulumi)
cd pulumi
pulumi up

# 3. Update kubeconfig to use VIP
sed -i '' 's|192.168.1.51|192.168.1.50|' ../kubeconfig

# 4. Join additional nodes using VIP
./homelab bootstrap --node pi-1
./homelab k3s --node pi-1 --server https://192.168.1.50:6443
```

## Troubleshooting

### Kube-vip pods not running

Check pod status and events:
```bash
kubectl describe pods -n kube-system -l app.kubernetes.io/name=kube-vip
```

Common issues:
- **Interface not found**: Check `kubevip:interface` config matches your network interface
- **VIP already in use**: Ensure 192.168.1.50 is not assigned to another device
- **No control plane nodes**: Kube-vip requires nodes with `node-role.kubernetes.io/control-plane=true`

### VIP not responding

Check leader election:
```bash
kubectl get leases -n kube-system -o yaml | grep -A 10 kube-vip
```

View kube-vip logs:
```bash
kubectl logs -n kube-system -l app.kubernetes.io/name=kube-vip --tail=100
```

### Conflict with MetalLB

Ensure `svc_enable=false` in the DaemonSet configuration. Check:
```bash
kubectl get daemonset -n kube-system kube-vip -o yaml | grep svc_enable
```

Should show: `value: "false"`

## Future Enhancements

- [ ] Migrate MetalLB to Pulumi Go
- [ ] Migrate Istio to Pulumi Go
- [ ] Migrate cert-manager to Pulumi Go
- [ ] Add Prometheus ServiceMonitor for kube-vip metrics
- [ ] Automate kubeconfig VIP update
- [ ] Add health checks and monitoring
- [ ] CLI integration: `homelab deploy` command to run `pulumi up`

## References

- [Kube-vip Documentation](https://kube-vip.io/)
- [Kube-vip K3s Guide](https://kube-vip.io/docs/usage/k3s/)
- [Pulumi Kubernetes Provider](https://www.pulumi.com/docs/intro/languages/go/)
